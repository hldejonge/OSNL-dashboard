<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWO Open Science Collaboration Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info-panel { position: absolute; top: 10px; right: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; max-width: 320px; }
        .info-panel h2 { font-size: 16px; margin-bottom: 10px; color: #333; }
        .info-panel p { font-size: 13px; color: #666; margin-bottom: 8px; }
        .info-panel select { width: 100%; padding: 8px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; font-size: 12px; }
        .legend-circle { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; background: #6293F5; }
        .btn { margin-top: 8px; padding: 8px 12px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px; }
        .btn:hover { background: #e0e0e0; }
        .leaflet-popup-content { max-height: 300px; overflow-y: auto; }
        .project-list { margin-top: 8px; padding: 0; list-style: none; }
        .project-list li { margin: 4px 0; font-size: 12px; }
        .project-list a { color: #0066cc; text-decoration: none; }
        .project-list a:hover { text-decoration: underline; }
        #all-projects-panel { display: none; position: absolute; top: 10px; left: 10px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        #all-projects-panel h3 { margin-bottom: 10px; }
        #all-projects-panel .close { float: right; cursor: pointer; font-size: 18px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <h2>Regieorgaan Open Science</h2>
        <label for="funding-select" style="font-size:12px;">Filter by Funding Scheme:</label>
        <select id="funding-select" onchange="filterByScheme()">
            <option value="all">All Funding Schemes</option>
        </select>
        <p id="stats">Loading...</p>
        <div class="legend-item"><div class="legend-circle"></div> Dutch institutions</div>
        <p style="font-size: 11px; color: #888;">Click DOI to view project (if available)<br>Line thickness = collaboration count</p>
        <button class="btn" onclick="toggleLinks()">Toggle lines</button>
        <button class="btn" onclick="showAllProjects()">All projects</button>
    </div>
    <div id="all-projects-panel">
        <span class="close" onclick="hideAllProjects()">&times;</span>
        <h3>All Projects (<span id="project-count"></span>)</h3>
        <ul id="all-projects-list" class="project-list"></ul>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([52.2, 5.5], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '© OpenStreetMap | NWO'}).addTo(map);

        let linksLayer = null, markersLayer = null, showLinks = true;
        let currentScheme = 'all';
        let allData = null;

        // Load data from JSON file
        fetch('collaboration_data.json')
            .then(response => response.json())
            .then(data => {
                allData = data;
                initFundingSelect();
                renderMap('all');
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('stats').innerHTML = 'Error loading data';
            });

        function initFundingSelect() {
            const select = document.getElementById('funding-select');
            allData.funding_schemes.forEach(scheme => {
                const option = document.createElement('option');
                option.value = scheme;
                option.textContent = scheme;
                select.appendChild(option);
            });
        }

        function filterByScheme() {
            currentScheme = document.getElementById('funding-select').value;
            renderMap(currentScheme);
        }

        function renderMap(schemeFilter) {
            if (linksLayer) map.removeLayer(linksLayer);
            if (markersLayer) map.removeLayer(markersLayer);

            const filteredAllProjects = schemeFilter === 'all'
                ? allData.all_projects
                : allData.all_projects.filter(p => p.funding_scheme === schemeFilter);

            const institutions = allData.institutions.map(inst => {
                const filteredProjects = schemeFilter === 'all'
                    ? inst.projects
                    : inst.projects.filter(p => p.funding_scheme === schemeFilter);
                return { ...inst, projects: filteredProjects, count: filteredProjects.length };
            }).filter(inst => inst.count > 0);

            document.getElementById('stats').innerHTML =
                `<strong>${filteredAllProjects.length}</strong> total projects<br>` +
                `<strong>${institutions.length}</strong> institutions on map`;

            if (institutions.length === 0) return;

            const maxCount = Math.max(...institutions.map(i => i.count));

            // Filter links by funding scheme
            const filteredLinks = schemeFilter === 'all'
                ? allData.links
                : allData.links.filter(l => l.scheme_counts && l.scheme_counts[schemeFilter] > 0)
                    .map(l => ({ ...l, count: l.scheme_counts[schemeFilter] }));

            const maxLinkCount = filteredLinks.length > 0 ? Math.max(...filteredLinks.map(l => l.count)) : 1;

            linksLayer = L.layerGroup();
            markersLayer = L.layerGroup();

            filteredLinks.forEach(link => {
                const weight = 1 + (link.count / maxLinkCount) * 8;
                const line = L.polyline([[link.source.lat, link.source.lng], [link.target.lat, link.target.lng]],
                    { color: '#6293F5', weight: weight, opacity: 0.6 });
                line.bindPopup(`<strong>${link.source.name}</strong> ↔ <strong>${link.target.name}</strong><br>${link.count} collaborations`);
                linksLayer.addLayer(line);
            });
            if (showLinks) linksLayer.addTo(map);

            institutions.forEach(inst => { const radius = 8 + (inst.count / maxCount) * 22;
                const circle = L.circleMarker([inst.lat, inst.lng], { radius, fillColor: '#6293F5', color: '#fff', weight: 2, fillOpacity: 0.8 });
                let projectList = inst.projects ? '<ul class="project-list">' + inst.projects.map(p => {
                    const isUrl = p.grant_id.startsWith('http');
                    const display = p.grant_id.replace('https://doi.org/','');
                    return isUrl
                        ? `<li><a href="${p.grant_id}" target="_blank">${display}</a> - ${p.title}</li>`
                        : `<li><strong>${display}</strong> - ${p.title}</li>`;
                }).join('') + '</ul>' : '';
                circle.bindPopup(`<strong>${inst.name}</strong><br><em>${inst.count} projects</em>${projectList}`, { maxWidth: 400 });
                circle.on('mouseover', function() { this.setStyle({ fillOpacity: 1, weight: 3 }); this.openPopup(); });
                circle.on('mouseout', function() { this.setStyle({ fillOpacity: 0.8, weight: 2 }); });
                markersLayer.addLayer(circle);
            });
            markersLayer.addTo(map);
        }

        function toggleLinks() {
            showLinks = !showLinks;
            if (showLinks) linksLayer.addTo(map);
            else map.removeLayer(linksLayer);
        }

        function showAllProjects() {
            const projects = currentScheme === 'all'
                ? allData.all_projects
                : allData.all_projects.filter(p => p.funding_scheme === currentScheme);

            document.getElementById('project-count').textContent = projects.length;
            document.getElementById('all-projects-list').innerHTML = projects.map(p => {
                const isUrl = p.grant_id.startsWith('http');
                const display = p.grant_id.replace('https://doi.org/','');
                return isUrl
                    ? `<li><a href="${p.grant_id}" target="_blank">${display}</a> - ${p.title}</li>`
                    : `<li><strong>${display}</strong> - ${p.title}</li>`;
            }).join('');
            document.getElementById('all-projects-panel').style.display = 'block';
        }

        function hideAllProjects() {
            document.getElementById('all-projects-panel').style.display = 'none';
        }
    </script>
</body>
</html>
